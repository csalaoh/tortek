<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Tizedesman√≥</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e0f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #333;
      -webkit-overflow-scrolling: touch;
    }

    h1 {
      color: #006064;
      margin-bottom: 5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 900px;
      width: 100%;
    }

    /* --- K√âPERNY≈êK --- */
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #game-screen {
      display: none;
    }

    #report-screen {
      display: none;
      padding: 20px;
    }

    #name-input {
      font-size: 1.5em;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      width: 80%;
      margin-bottom: 20px;
      text-align: center;
    }

    /* --- K√ñZ√ñS ST√çLUSOK --- */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #006064;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      flex-wrap: wrap;
    }

    .student-name-display {
      color: #80deea;
      font-size: 1.1em;
    }

    .settings-box {
      background: #f1f8e9;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #c5e1a5;
      text-align: left;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .setting-item label {
      font-weight: bold;
      color: #558b2f;
      display: block;
      margin-bottom: 5px;
    }

    select,
    input[type="checkbox"],
    input[type="text"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #bbb;
      width: 100%;
      background: #fff;
      box-sizing: border-box;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .checkbox-wrapper input {
      width: auto;
    }

    .suboptions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .suboptions .setting-item {
      margin: 0;
    }

    .problem-container {
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      min-height: 100px;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #b2ebf2;
      font-size: 1.8em;
      line-height: 1.3;
    }

    .operator {
      margin: 0 10px;
      font-weight: bold;
      color: #00838f;
    }

    .bracket {
      font-size: 1.2em;
      color: #d84315;
      font-weight: 300;
      margin: 0 2px;
    }

    .num {
      font-weight: 800;
      color: #263238;
      margin: 0 3px;
    }

    .num.negative {
      color: #ad1457;
    }

    .answer-section {
      background-color: #fafafa;
      border: 2px dashed #0288d1;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    }

    .decimal-input {
      max-width: 320px;
      width: 100%;
      height: 60px;
      font-size: 1.6em;
      text-align: center;
      border: 2px solid #ff9800;
      border-radius: 10px;
    }

    .hint {
      font-size: 0.95em;
      color: #546e7a;
    }

    /* --- SEG√çTS√âG DOBOZ --- */
    #help-container {
      display: none;
      background-color: #fff8e1;
      border: 2px solid #ffb300;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      text-align: left;
      animation: fadeIn 0.5s;
    }

    .help-step {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border-left: 4px solid #ffb300;
      font-size: 1.1em;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- GOMBOK --- */
    button {
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin: 5px;
      -webkit-appearance: none;
      appearance: none;
      touch-action: manipulation;
    }

    .btn-start {
      background-color: #009688;
      color: white;
      width: 100%;
      max-width: 300px;
      font-size: 1.3em;
      margin-top: 10px;
    }

    .btn-check {
      background-color: #00bcd4;
      color: white;
    }

    .btn-next {
      background-color: #ff9800;
      color: white;
      display: none;
    }

    .btn-finish {
      background-color: #d32f2f;
      color: white;
      float: right;
      font-size: 0.9em;
    }

    .btn-reset {
      background-color: #8bc34a;
      color: white;
      width: 100%;
      margin-top: 10px;
    }

    .btn-help-yes {
      background-color: #ffca28;
      color: #3e2723;
    }

    .btn-help-continue {
      background-color: #8bc34a;
      color: white;
    }

    .btn-help-more {
      background-color: #03a9f4;
      color: white;
    }

    .btn-send {
      background-color: #2196f3;
      color: white;
      width: 100%;
      margin-top: 15px;
      font-size: 1.2em;
      display: none;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #feedback {
      margin-top: 20px;
      font-size: 1.1em;
      font-weight: bold;
      min-height: 30px;
      padding: 10px;
      border-radius: 8px;
    }

    .correct {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }

    .incorrect {
      background-color: #ffebee;
      color: #c62828;
    }

    .warning {
      background-color: #fffde7;
      color: #f9a825;
    }

    #report-output {
      width: 100%;
      font-family: monospace;
      padding: 15px;
      border: 2px solid #006064;
      border-radius: 8px;
      resize: none;
      box-sizing: border-box;
    }

    .report-buttons button {
      padding: 15px 30px;
      font-size: 1.2em;
    }

    #status-message {
      margin-top: 15px;
      font-weight: bold;
      min-height: 1.5em;
    }
  </style>
</head>

<body>
  <h1>ü¶ä Tizedesman√≥ - alapm≈±veletek tizedes t√∂rtekkel</h1>

  <div class="container">
    <div id="start-screen">
      <h2>Szia! Hogy h√≠vnak?</h2>
      <p>A gyakorl√°s v√©g√©n az eredm√©nyedet automatikusan elk√ºldj√ºk a tan√°rnak.</p>
      <form id="login-form" style="width: 100%; display: flex; flex-direction: column; align-items: center">
        <input type="text" id="name-input" placeholder="√çrd ide a neved..." enterkeyhint="go" required />
        <button type="submit" class="btn-start">Indulhat a gyakorl√°s!</button>
      </form>
    </div>

    <div id="game-screen">
      <div class="top-bar">
        <div>
          <span class="student-name-display" id="display-name">Tanul√≥</span> |
          Szint: <span id="level-text">1. Kezd≈ë</span>
        </div>
        <button class="btn-finish" onclick="finishSession()">üìÑ Befejez√©s √©s K√ºld√©s</button>
      </div>

      <div class="settings-box">
        <div class="settings-grid">
          <div class="setting-item">
            <label>Feladat t√≠pusa:</label>
            <select id="op-type" onchange="syncUI(); gameReset();">
              <option value="add">Tizedes t√∂rtek √∂sszead√°sa</option>
              <option value="sub">Tizedes t√∂rtek kivon√°sa</option>
              <option value="mul">Tizedes t√∂rtek szorz√°sa</option>
              <option value="divInt">Oszt√°s (az oszt√≥ eg√©sz)</option>
              <option value="divDec">Oszt√°s (az oszt√≥ is tizedes)</option>
              <option value="mixed" selected>Vegyes (minden)</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Neh√©zs√©gi szint:</label>
            <select id="diff-level" onchange="gameReset()">
              <option value="1">1. Kezd≈ë</option>
              <option value="2">2. Halad√≥</option>
              <option value="3">3. Mester</option>
            </select>
          </div>
          <div class="setting-item" id="term-count-wrap">
            <label>Tagok sz√°ma (√∂sszead√°sn√°l):</label>
            <select id="term-count" onchange="gameReset()">
              <option value="2">2 tag</option>
              <option value="3">3 tag</option>
              <option value="4">4 tag</option>
            </select>
          </div>
        </div>

        <div class="suboptions">
          <div class="setting-item" id="brackets-wrap">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="use-brackets" onchange="gameReset()" />
              <label for="use-brackets">Legyen benne z√°r√≥jel (√∂sszead√°sn√°l)</label>
            </div>
          </div>
          <div class="setting-item" id="negatives-wrap">
            <div class="checkbox-wrapper">
              <input type="checkbox" id="use-negatives" onchange="gameReset()" />
              <label for="use-negatives">Lehessen benne negat√≠v sz√°m is</label>
            </div>
          </div>
        </div>

        <button class="btn-reset" onclick="gameReset()">üîÑ √öj param√©terek alkalmaz√°sa</button>
      </div>

      <div class="problem-container" id="problem-box"></div>

      <div id="help-container">
        <h3 style="color: #f57f17; margin-top: 0">üí° Seg√≠ts√©g a Tizedesman√≥t√≥l</h3>
        <div id="help-content-area"></div>
        <div id="help-controls" style="margin-top: 10px"></div>
      </div>

      <div class="answer-section">
        <div class="input-row">
          <span style="font-size: 2em">=</span>
          <input type="text" id="inp-decimal" class="decimal-input" inputmode="decimal" placeholder="Pl. 3,25"
            enterkeyhint="done" autocomplete="off" autocorrect="off" spellcheck="false" />
        </div>
        <div class="hint">Tipp: vessz≈ëvel √©s ponttal is be√≠rhatod (3,25 vagy 3.25).</div>
      </div>

      <button class="btn-check" onclick="checkAnswer()" id="check-btn">Ellen≈ërz√©s</button>
      <button class="btn-next" onclick="generateProblem()" id="next-btn">K√∂vetkez≈ë feladat</button>

      <div id="feedback"></div>
    </div>

    <div id="report-screen">
      <h2>üìä Gyakorl√°si Jelent√©s</h2>

      <div id="status-message"></div>

      <button id="btn-send-data" class="btn-send" onclick="sendReportToGoogle()">
        üöÄ Eredm√©ny k√ºld√©se a Tan√°rnak
      </button>

      <p style="margin-top: 20px; font-size: 0.9em; color: #666">
        Ha a k√ºld√©s nem siker√ºlne, itt a biztons√°gi m√°solat:
      </p>
      <textarea id="report-output" readonly rows="10"></textarea>

      <div class="report-buttons">
        <button onclick="copyReport()" style="background-color: #555; color: white; font-size: 0.9em">
          M√°sol√°s v√°g√≥lapra (Tartal√©k)
        </button>
        <button onclick="window.location.reload()" style="background-color: #ff9800; color: white">
          √öjrakezd√©s
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================================
    // CONFIG: IDE M√ÅSOLD BE A KAPOTT GOOGLE SCRIPT LINKET!
    // ==========================================================
    const GOOGLE_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbxAaMcBrUw2lujLKltwkw2jwRHhW_7B9W9vURqQUqxTAZN2eclh_6f0AB_mQ1S-m7gJfw/exec";
    // ==========================================================

    // --- J√ÅT√âK √ÅLLAPOT ---
    let studentName = "";
    let startTime;
    let sessionLog = [];
    let currentProblemText = "";
    let currentSolution = null; // {n,d}
    let currentSolutionDisplay = "";
    let streak = 0;
    const STREAK_GOAL = 5;

    // Seg√≠ts√©g v√°ltoz√≥k
    let wrongAnswerCount = 0;
    let solutionSteps = [];
    let helpStepIndex = 0;

    // Adatcsomag a k√ºld√©shez
    let reportDataPackage = null;

    // --- EG√âSZ/RACION√ÅLIS MATEK (pontos ellen≈ërz√©shez) ---
    function gcd(a, b) {
      a = Math.abs(a);
      b = Math.abs(b);
      while (b !== 0) {
        const t = a % b;
        a = b;
        b = t;
      }
      return a;
    }
    function simplifyFrac(f) {
      if (f.d < 0) {
        f.n = -f.n;
        f.d = -f.d;
      }
      if (f.n === 0) return { n: 0, d: 1 };
      const g = gcd(f.n, f.d);
      return { n: f.n / g, d: f.d / g };
    }
    function addFrac(a, b) {
      return simplifyFrac({ n: a.n * b.d + b.n * a.d, d: a.d * b.d });
    }
    function subFrac(a, b) {
      return simplifyFrac({ n: a.n * b.d - b.n * a.d, d: a.d * b.d });
    }
    function mulFrac(a, b) {
      return simplifyFrac({ n: a.n * b.n, d: a.d * b.d });
    }
    function divFrac(a, b) {
      if (b.n === 0) return { n: 0, d: 1 };
      return simplifyFrac({ n: a.n * b.d, d: a.d * b.n });
    }
    function equalFrac(a, b) {
      return a.n * b.d === b.n * a.d;
    }

    // Biztons√°gos tizedes beolvas√°s (vessz≈ë vagy pont)
    function parseDecimalToFraction(raw) {
      if (raw == null) return null;
      let s = String(raw).trim();
      if (s === "") return null;
      s = s.replace(/\s+/g, "");
      s = s.replace(/,/g, ".");
      // + jel enged√©lyez√©se
      if (s.startsWith("+")) s = s.slice(1);

      // Csak sz√°m / tizedes
      if (!/^-?\d+(\.\d+)?$/.test(s)) return null;

      const neg = s.startsWith("-");
      if (neg) s = s.slice(1);
      const parts = s.split(".");
      const intPart = parts[0] || "0";
      const fracPart = parts[1] || "";
      const scale = Math.pow(10, fracPart.length);
      const n = parseInt(intPart, 10) * scale + (fracPart === "" ? 0 : parseInt(fracPart, 10));
      const signedN = neg ? -n : n;
      return simplifyFrac({ n: signedN, d: scale });
    }

    function fracToDecimalString(f) {
      // Felt√©telezz√ºk: termin√°l√≥ tizedes (d = 2^a*5^b)
      // Ennek ellen√©re: ha m√©gsem termin√°l√≥, akkor t√∂rt form√°t adunk vissza.
      f = simplifyFrac({ n: f.n, d: f.d });
      if (f.d === 1) return String(f.n);

      let d = f.d;
      let a = 0,
        b = 0;
      while (d % 2 === 0) {
        d /= 2;
        a++;
      }
      while (d % 5 === 0) {
        d /= 5;
        b++;
      }
      if (d !== 1) {
        return `${f.n}/${f.d}`;
      }

      const k = Math.max(a, b);
      const factor = Math.pow(10, k);
      const scaledN = f.n * (factor / f.d);
      const neg = scaledN < 0;
      const absN = Math.abs(scaledN);
      const intStr = String(Math.floor(absN / factor));
      let fracStr = String(absN % factor).padStart(k, "0");
      // jobb oldali null√°k lev√°g√°sa
      fracStr = fracStr.replace(/0+$/, "");
      const out = fracStr.length ? `${intStr}.${fracStr}` : intStr;
      return neg ? `-${out}` : out;
    }

    // Magyar megjelen√≠t√©shez: pont -> vessz≈ë
    function toHuDecimal(s) {
      return String(s).replace(/\./g, ",");
    }

    function formatNumberHTML(numStr) {
      const t = String(numStr).trim();
      const isNeg = t.startsWith("-") || t.startsWith("(-") || t.startsWith("(‚àí") || t.includes("(-");
      const shown = numStr;
      return `<span class="num ${isNeg ? "negative" : ""}">${shown}</span>`;
    }

    // --- UI ---
    function syncUI() {
      const opType = document.getElementById("op-type").value;
      const showTerm = opType === "add" || opType === "mixed";
      const showBrackets = opType === "add" || opType === "mixed";
      const showNeg = opType === "add" || opType === "sub" || opType === "mixed";

      document.getElementById("term-count-wrap").style.display = showTerm ? "block" : "none";
      document.getElementById("brackets-wrap").style.display = showBrackets ? "block" : "none";
      document.getElementById("negatives-wrap").style.display = showNeg ? "block" : "none";

      // Z√°r√≥jel csak akkor √©rtelmes, ha 3+ tag van
      const termCount = parseInt(document.getElementById("term-count").value, 10);
      document.getElementById("use-brackets").disabled = !(termCount >= 3);
    }

    // --- BEL√âP√âS ---
    function enterGame() {
      const nameInput = document.getElementById("name-input").value.trim();
      if (nameInput === "") {
        alert("K√©rlek √≠rd be a neved!");
        return;
      }
      if (document.activeElement) {
        document.activeElement.blur();
      }

      studentName = nameInput;
      startTime = new Date();
      document.getElementById("display-name").innerText = studentName;
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-screen").style.display = "block";
      document.getElementById("report-screen").style.display = "none";
      syncUI();
      gameReset();
    }

    // --- SEG√âDF√úGGV√âNYEK ---
    function getSettingsDescription() {
      const opType = document.getElementById("op-type");
      const diffLevel = document.getElementById("diff-level");
      const opText = opType.options[opType.selectedIndex].text;
      const diffText = diffLevel.options[diffLevel.selectedIndex].text;

      const useNeg = document.getElementById("use-negatives").checked;
      const termCountWrap = document.getElementById("term-count-wrap");
      const termCount = termCountWrap.style.display === "none" ? null : document.getElementById("term-count").value;
      const useBr = document.getElementById("use-brackets").checked && !document.getElementById("use-brackets").disabled;

      const bits = [diffText, opText];
      if (termCount) bits.push(`${termCount} tag`);
      if (useBr) bits.push("+ Z√°r√≥jel");
      if (useNeg) bits.push("+ Negat√≠v");
      return bits.join(" | ");
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getDiffSpec(diff) {
      // C√©l: olyan sz√°mok, amelyekkel a v√©geredm√©ny termin√°l√≥ tizedes lesz.
      if (diff === "1") {
        return { maxAbs: 20, maxDp: 1 };
      }
      if (diff === "2") {
        return { maxAbs: 60, maxDp: 2 };
      }
      return { maxAbs: 200, maxDp: 3 };
    }

    function makeDecimal(maxAbs, maxDp, allowNegative) {
      const dp = randInt(0, maxDp);
      const scale = Math.pow(10, dp);
      // 0 is lehessen, de ritk√°bban
      let absN = randInt(0, maxAbs * scale);
      if (absN === 0 && Math.random() < 0.7) absN = randInt(1, Math.max(1, Math.floor(maxAbs * scale / 3)));
      let n = absN;
      if (allowNegative && Math.random() < 0.35) n = -n;
      const f = simplifyFrac({ n, d: scale });
      const str = fracToDecimalString(f);
      return { str, frac: f };
    }

    function makeNonZeroDecimal(maxAbs, maxDp, allowNegative) {
      let x;
      do {
        x = makeDecimal(maxAbs, maxDp, allowNegative);
      } while (x.frac.n === 0);
      return x;
    }

    function gameReset() {
      streak = 0;
      const levelSelect = document.getElementById("diff-level");
      document.getElementById("level-text").innerText = levelSelect.options[levelSelect.selectedIndex].text;
      syncUI();
      generateProblem();
    }

    function buildStepsAndSolve(exprParts) {
      // exprParts: {nums:[{str,frac}], ops:["+"|"-"|"*"|"/"], brackets:{start,end}|null}
      const displayOps = { "+": "+", "-": "‚àí", "*": "¬∑", "/": ":" };
      const opName = { "+": "√∂sszead√°st", "-": "kivon√°st", "*": "szorz√°st", "/": "oszt√°st" };

      const perform = (a, b, op) => {
        if (op === "+") return addFrac(a, b);
        if (op === "-") return subFrac(a, b);
        if (op === "*") return mulFrac(a, b);
        return divFrac(a, b);
      };

      const nums = exprParts.nums.map((x) => x.frac);
      const ops = [...exprParts.ops];
      const br = exprParts.brackets;
      solutionSteps = [];

      const stepMsg = (a, b, op, res) => {
        const left = toHuDecimal(fracToDecimalString(a));
        const right = toHuDecimal(fracToDecimalString(b));
        const out = toHuDecimal(fracToDecimalString(res));
        return `V√©gezd el a <b>${opName[op]}</b>: ${left} ${displayOps[op]} ${right} = <b>${out}</b>.`;
      };

      let workNums = [...nums];
      let workOps = [...ops];

      // 1) z√°r√≥jel (ha van)
      if (br) {
        const i = br.start;
        const a = workNums[i];
        const b = workNums[i + 1];
        const op = workOps[i];
        const res = perform(a, b, op);
        solutionSteps.push(stepMsg(a, b, op, res));
        workNums.splice(i, 2, res);
        workOps.splice(i, 1);
      }

      // 2) szorz√°s/oszt√°s
      let idx = 0;
      while (idx < workOps.length) {
        if (workOps[idx] === "*" || workOps[idx] === "/") {
          const a = workNums[idx];
          const b = workNums[idx + 1];
          const op = workOps[idx];
          const res = perform(a, b, op);
          solutionSteps.push(stepMsg(a, b, op, res));
          workNums.splice(idx, 2, res);
          workOps.splice(idx, 1);
        } else {
          idx++;
        }
      }

      // 3) √∂sszead√°s/kivon√°s
      while (workOps.length) {
        const a = workNums[0];
        const b = workNums[1];
        const op = workOps[0];
        const res = perform(a, b, op);
        solutionSteps.push(stepMsg(a, b, op, res));
        workNums.splice(0, 2, res);
        workOps.shift();
      }

      return simplifyFrac(workNums[0]);
    }

    function generateAddition(spec, allowNegative, termCount, useBrackets) {
      const nums = [];
      for (let i = 0; i < termCount; i++) nums.push(makeDecimal(spec.maxAbs, spec.maxDp, allowNegative));
      const ops = Array(termCount - 1).fill("+");

      let brackets = null;
      if (useBrackets && termCount >= 3) {
        // z√°r√≥jel 2 egym√°s melletti tag k√∂r√©: (i, i+1)
        const start = randInt(0, termCount - 2);
        brackets = { start, end: start + 1 };
      }
      return { nums, ops, brackets, displayOps: { "+": "+" } };
    }

    function generateSubtraction(spec, allowNegative) {
      const a = makeDecimal(spec.maxAbs, spec.maxDp, allowNegative);
      const b = makeDecimal(spec.maxAbs, spec.maxDp, allowNegative);
      return { nums: [a, b], ops: ["-"], brackets: null };
    }

    function generateMultiplication(spec) {
      // szorz√°sn√°l: ne legyen t√∫l sok tizedes a v√©geredm√©ny
      const a = makeDecimal(spec.maxAbs, Math.min(spec.maxDp, 2), false);
      const b = makeDecimal(spec.maxAbs, Math.min(spec.maxDp, 2), false);
      return { nums: [a, b], ops: ["*"], brackets: null };
    }

    function generateDivisionIntDivisor(spec) {
      // Biztos termin√°l√≥ √©s "sz√©p": el≈ëbb v√°lasztunk eredm√©nyt √©s oszt√≥t, majd kisz√°moljuk az osztand√≥t.
      const q = makeDecimal(spec.maxAbs, Math.min(spec.maxDp, 2), false);
      const divisor = randInt(2, spec.diff === "1" ? 9 : 20);
      const d = simplifyFrac({ n: divisor, d: 1 });
      const dividend = mulFrac(q.frac, d);
      const aStr = fracToDecimalString(dividend);
      // ha m√©gis cs√∫nya lenne, pr√≥b√°lkozunk √∫jra
      if (aStr.includes("/")) return generateDivisionIntDivisor(spec);
      return {
        nums: [{ str: aStr, frac: dividend }, { str: String(divisor), frac: d }],
        ops: ["/"],
        brackets: null,
        forcedResult: q.frac,
      };
    }

    function generateDivisionDecDivisor(spec) {
      // V√°lasszunk q-t √©s d-t (d tizedes), majd a = q*d
      const q = makeDecimal(spec.maxAbs, Math.min(spec.maxDp, 2), false);
      const dObj = makeNonZeroDecimal(Math.min(spec.maxAbs, 30), Math.min(spec.maxDp, 2), false);
      // Ker√ºlj√ºk az 1-et t√∫l gyakran
      if (Math.abs(dObj.frac.n) === dObj.frac.d && Math.random() < 0.7) return generateDivisionDecDivisor(spec);
      const dividend = mulFrac(q.frac, dObj.frac);
      const aStr = fracToDecimalString(dividend);
      const dStr = dObj.str;
      if (aStr.includes("/") || dStr.includes("/")) return generateDivisionDecDivisor(spec);
      return {
        nums: [{ str: aStr, frac: dividend }, { str: dStr, frac: dObj.frac }],
        ops: ["/"],
        brackets: null,
        forcedResult: q.frac,
      };
    }

    function generateProblem() {
      // UI Reset
      const inp = document.getElementById("inp-decimal");
      inp.value = "";
      document.getElementById("feedback").innerText = "";
      document.getElementById("feedback").className = "";
      document.getElementById("next-btn").style.display = "none";
      document.getElementById("check-btn").style.display = "inline-block";

      // Seg√≠ts√©g Reset
      document.getElementById("help-container").style.display = "none";
      document.getElementById("help-content-area").innerHTML = "";
      document.getElementById("help-controls").innerHTML = "";
      wrongAnswerCount = 0;
      solutionSteps = [];
      helpStepIndex = 0;

      const opTypeSelected = document.getElementById("op-type").value;
      const diff = document.getElementById("diff-level").value;
      const specBase = getDiffSpec(diff);
      const allowNeg = document.getElementById("use-negatives").checked;
      const termCount = parseInt(document.getElementById("term-count").value, 10);
      const useBr = document.getElementById("use-brackets").checked && !document.getElementById("use-brackets").disabled;

      // Spec kieg√©sz√≠t√©s (divisionben hasznos)
      const spec = { ...specBase, diff };

      // M≈±velet kiv√°laszt√°sa (vegyes eset√©n)
      let opType = opTypeSelected;
      if (opTypeSelected === "mixed") {
        opType = pick(["add", "sub", "mul", "divInt", "divDec"]);
      }

      let expr;
      if (opType === "add") {
        expr = generateAddition(spec, allowNeg, termCount, useBr);
      } else if (opType === "sub") {
        expr = generateSubtraction(spec, allowNeg);
      } else if (opType === "mul") {
        expr = generateMultiplication(spec);
      } else if (opType === "divInt") {
        expr = generateDivisionIntDivisor(spec);
      } else {
        expr = generateDivisionDecDivisor(spec);
      }

      // HTML + sz√∂veg log
      const displayOps = { "+": "+", "-": "‚àí", "*": "¬∑", "/": ":" };
      let html = "";
      let textLog = "";

      const b = expr.brackets;
      for (let i = 0; i < expr.nums.length; i++) {
        if (b && i === b.start) {
          html += `<span class="bracket">(</span>`;
          textLog += "(";
        }
        // negat√≠v sz√°mokn√°l tegy√ºnk z√°r√≥jelet a szebb olvashat√≥s√°g√©rt
        const s = toHuDecimal(expr.nums[i].str);
        const isNeg = s.trim().startsWith("-");
        const shown = isNeg ? `(${s})` : s;
        html += formatNumberHTML(shown);
        textLog += shown;

        if (b && i === b.end) {
          html += `<span class="bracket">)</span>`;
          textLog += ")";
        }

        if (i < expr.ops.length) {
          html += `<span class="operator">${displayOps[expr.ops[i]]}</span>`;
          textLog += ` ${displayOps[expr.ops[i]]} `;
        }
      }

      document.getElementById("problem-box").innerHTML = html;
      currentProblemText = textLog;

      // Megold√°s + l√©p√©sek
      const solved = buildStepsAndSolve({ nums: expr.nums, ops: expr.ops, brackets: expr.brackets });
      currentSolution = solved;
      currentSolutionDisplay = toHuDecimal(fracToDecimalString(solved));
    }

    // --- SEG√çTS√âG ---
    function offerHelp() {
      document.getElementById("help-container").style.display = "block";
      document.getElementById("help-content-area").innerHTML =
        "<p>M√°r h√°romszor pr√≥b√°ltad, de nem siker√ºlt. Szeretn√©d, ha seg√≠ten√©k az els≈ë l√©p√©sben?</p>";
      document.getElementById("help-controls").innerHTML = `
          <button class="btn-help-yes" onclick="showNextStep()">Igen, k√©rek seg√≠ts√©get</button>
          <button onclick="hideHelp()">Nem, m√©g pr√≥b√°lkozom</button>
        `;
    }

    function showNextStep() {
      const helpContent = document.getElementById("help-content-area");
      const helpControls = document.getElementById("help-controls");

      if (helpStepIndex < solutionSteps.length) {
        const stepHtml = `<div class="help-step"><b>${helpStepIndex + 1}. L√©p√©s:</b> ${solutionSteps[helpStepIndex]}</div>`;
        helpContent.innerHTML = stepHtml;
        helpStepIndex++;
        helpControls.innerHTML = `
            <button class="btn-help-continue" onclick="hideHelp()">K√∂sz√∂n√∂m, folytatom √∂n√°ll√≥an</button>
            ${helpStepIndex < solutionSteps.length ? '<button class="btn-help-more" onclick="showNextStep()">M√©g mindig elakadtam, mi a k√∂vetkez≈ë?</button>' : ""}
          `;
      } else {
        helpContent.innerHTML += `<div class="help-step">M√°r minden l√©p√©sen v√©gigment√ºnk! Az eredm√©nynek <b>${currentSolutionDisplay}</b>-nek kell lennie.</div>`;
        helpControls.innerHTML = `<button class="btn-help-continue" onclick="hideHelp()">Be√≠rom a megold√°st</button>`;
      }
    }

    function hideHelp() {
      document.getElementById("inp-decimal").focus();
    }

    function checkAnswer() {
      const feedback = document.getElementById("feedback");
      const raw = document.getElementById("inp-decimal").value;
      const userFrac = parseDecimalToFraction(raw);

      if (!userFrac) {
        feedback.innerHTML = "√çrd be a v√°laszt tizedes sz√°mmal (pl. 3,25)!";
        feedback.className = "incorrect";
        return;
      }

      const correct = currentSolution;
      const isCorrect = equalFrac(userFrac, correct);
      const userText = String(raw).trim();

      const logEntry = {
        problem: currentProblemText,
        userAnswer: userText,
        correctAnswer: currentSolutionDisplay,
        isCorrect: false,
        note: "",
        settingsDesc: getSettingsDescription(),
      };

      if (isCorrect) {
        feedback.innerHTML = `üéâ <b>T√∂k√©letes v√°lasz!</b><br>√úgyes vagy! A megold√°s helyes: <b>${currentSolutionDisplay}</b>`;
        feedback.className = "correct";
        document.getElementById("next-btn").style.display = "inline-block";
        document.getElementById("check-btn").style.display = "none";
        document.getElementById("help-container").style.display = "none";

        streak++;
        if (streak >= STREAK_GOAL) {
          const levelSelect = document.getElementById("diff-level");
          if (levelSelect.selectedIndex < levelSelect.options.length - 1) {
            levelSelect.selectedIndex++;
            streak = 0;
            feedback.innerHTML +=
              "<br>üèÜ <b>GRATUL√ÅLOK! SZINTL√âP√âS!</b><br>A k√∂vetkez≈ë feladatok kicsit nehezebbek lesznek.";
            syncUI();
          }
        }

        logEntry.isCorrect = true;
        sessionLog.push(logEntry);
      } else {
        wrongAnswerCount++;
        const attemptsLeft = 3 - wrongAnswerCount;
        if (wrongAnswerCount >= 3) {
          feedback.innerHTML = "‚ùå Sajnos nem j√≥. √ögy l√°tom elakadt√°l kicsit.";
          feedback.className = "incorrect";
          offerHelp();
        } else {
          feedback.innerHTML = `‚ùå Sajnos nem j√≥. Pr√≥b√°ld √∫jra! (M√©g ${attemptsLeft} pr√≥b√°lkoz√°s a seg√≠ts√©gig)`;
          feedback.className = "incorrect";
        }
        streak = 0;
        sessionLog.push(logEntry);
      }
    }

    // --- RIPORT √âS K√úLD√âS ---
    function finishSession() {
      const endTime = new Date();
      const timeDiffMs = endTime - startTime;
      const timeDiffMin = Math.round(timeDiffMs / 1000 / 60);

      const correctCount = sessionLog.filter((x) => x.isCorrect).length;
      const totalCount = sessionLog.length;
      const score = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

      const uniqueSettings = [...new Set(sessionLog.map((log) => log.settingsDesc))];

      document.getElementById("game-screen").style.display = "none";
      document.getElementById("report-screen").style.display = "block";

      let reportText = `TIZEDESMAN√ì JELENT√âS - ${studentName}\n`;
      reportText += `Eredm√©ny: ${score}% (${correctCount}/${totalCount})\n`;
      reportText += `Id≈ë: ${timeDiffMin} perc\n`;
      reportText += `Be√°ll√≠t√°sok: ${uniqueSettings.join(", ")}\n\n`;
      reportText += `R√©szletek:\n`;
      sessionLog.forEach((log, index) => {
        const status = log.isCorrect ? "‚úÖ" : "‚ùå";
        reportText += `${index + 1}. ${status} [${log.settingsDesc}] ${log.problem} = ${log.userAnswer}`;
        if (!log.isCorrect) reportText += ` (Helyes: ${log.correctAnswer})`;
        reportText += `\n`;
      });

      document.getElementById("report-output").value = reportText;

      reportDataPackage = {
        name: studentName,
        score: score,
        correct: correctCount,
        total: totalCount,
        time: timeDiffMin,
        settings: uniqueSettings.join(", "),
        log: reportText,
      };

      const btnSend = document.getElementById("btn-send-data");
      btnSend.style.display = "block";

      if (GOOGLE_SCRIPT_URL === "IDE_MASOLD_BE_A_GOOGLE_SCRIPT_LINKET" || GOOGLE_SCRIPT_URL === "") {
        document.getElementById("status-message").innerHTML =
          "‚ö†Ô∏è Nincs be√°ll√≠tva a tan√°ri link! Haszn√°ld a m√°sol√°st.";
        document.getElementById("status-message").style.color = "red";
        btnSend.style.display = "none";
      }
    }
    function sendReportToGoogle() {
      const btn = document.getElementById("btn-send-data");
      const statusDiv = document.getElementById("status-message");

      btn.disabled = true;
      btn.textContent = "K√ºld√©s...";

      const body = new URLSearchParams();
      for (const [k, v] of Object.entries(reportDataPackage)) body.append(k, String(v ?? ""));

      fetch(GOOGLE_SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        body
      }).then(() => {
        statusDiv.textContent = "‚úÖ K√ºld√©s megt√∂rt√©nt (ellen≈ërizd a t√°bl√°zatot).";
        btn.style.display = "none";
      }).catch(err => {
        statusDiv.textContent = "‚ùå Hiba a k√ºld√©skor. M√°sold ki a jelent√©st!";
        btn.disabled = false;
        btn.textContent = "√öjrapr√≥b√°lkoz√°s";
      });
    }


    function copyReport() {
      const reportOutput = document.getElementById("report-output");
      reportOutput.select();
      reportOutput.setSelectionRange(0, 99999);
      document.execCommand("copy");
      alert("‚úÖ A jelent√©s m√°solva!");
    }

    window.onload = function () {
      document.getElementById("start-screen").style.display = "flex";
      document.getElementById("game-screen").style.display = "none";
      document.getElementById("report-screen").style.display = "none";

      const loginForm = document.getElementById("login-form");
      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          enterGame();
        });
      }
      syncUI();
    };
  </script>
</body>

</html>