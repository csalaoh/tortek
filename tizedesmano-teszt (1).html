<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Tizedesman√≥ Teszt</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #e0f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #333;
      -webkit-overflow-scrolling: touch;
    }

    h1 {
      color: #006064;
      margin-bottom: 5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 900px;
      width: 100%;
      position: relative;
    }

    /* --- K√âPERNY≈êK --- */
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #game-screen {
      display: none;
    }

    #report-screen {
      display: none;
      padding: 20px;
    }

    #name-input {
      font-size: 1.5em;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      width: 80%;
      margin-bottom: 20px;
      text-align: center;
    }

    /* --- MODAL (Biztosan ez a v√°laszod?) --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-box {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      border: 4px solid #00acc1;
    }

    .modal-answer-preview {
      font-size: 1.8em;
      color: #006064;
      font-weight: bold;
      margin: 20px 0;
      background: #e0f7fa;
      padding: 10px;
      border-radius: 8px;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .btn-modal-yes {
      background-color: #4caf50;
      color: white;
    }

    .btn-modal-no {
      background-color: #f44336;
      color: white;
    }

    /* --- K√ñZ√ñS ST√çLUSOK --- */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #006064;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
      flex-wrap: wrap;
    }

    .student-name-display {
      color: #80deea;
      font-size: 1.1em;
    }

    .problem-container {
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      min-height: 100px;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #b2ebf2;
      font-size: 1.6em;
    }

    .fraction {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      vertical-align: middle;
      margin: 0 4px;
    }

    .numerator {
      border-bottom: 2px solid #333;
      padding: 0 4px;
      display: block;
    }

    .denominator {
      padding: 0 4px;
      display: block;
    }

    button {
      padding: 15px 30px;
      font-size: 1.2em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.1s, background-color 0.2s;
      font-weight: bold;
      margin: 5px;
    }

    button:hover {
      transform: scale(1.03);
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-start {
      background-color: #00acc1;
      color: white;
    }

    .btn-resume {
      background-color: #4caf50;
      color: white;
    }

    .btn-reset {
      background-color: #ff9800;
      color: white;
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .btn-prev {
      background-color: #9e9e9e;
      color: white;
    }

    .btn-next {
      background-color: #00acc1;
      color: white;
    }

    .btn-submit {
      background-color: #e53935;
      color: white;
    }

    .answer-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .input-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* K√ºld√©s gomb */
    .btn-send {
      background-color: #673ab7;
      color: white;
      margin-top: 10px;
      width: min(520px, 100%);
    }

    .report-buttons {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .loading {
      display: none;
      margin: 15px 0;
      font-weight: bold;
      color: #006064;
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #b2ebf2;
      border-top: 3px solid #006064;
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    #report-output {
      width: 100%;
      font-family: monospace;
      padding: 15px;
      border: 2px solid #006064;
      border-radius: 8px;
      resize: none;
      box-sizing: border-box;
    }

    .report-buttons button {
      padding: 15px 30px;
      font-size: 1.2em;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    #status-message {
      margin-top: 15px;
      font-weight: bold;
      min-height: 1.5em;
    }

    .warning-box {
      background-color: #fff8e1;
      border: 3px solid #f57f17;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      text-align: left;
      font-weight: bold;
      color: #3e2723;
    }

    /* --- EREDM√âNY KIEMEL√âS --- */
    .summary-box {
      background: #e8f5e9;
      border: 4px solid #43a047;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .summary-score {
      font-size: 1.3em;
      color: #444;
      margin-bottom: 15px;
      border-bottom: 1px solid #c8e6c9;
      padding-bottom: 10px;
    }

    .grade-label {
      font-size: 1rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 5px;
    }

    .grade-value {
      font-size: 5rem;
      font-weight: 900;
      color: #2e7d32;
      line-height: 1;
    }

    /* √öJ: Resume ter√ºlet */
    #resume-area {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    #new-game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* --- TIZEDESMAN√ì kieg√©sz√≠t≈ë st√≠lusok --- */
    .expr {
      font-size: 2.2em;
      font-weight: 700;
      text-align: center;
      line-height: 1.35;
    }

    .expr .term {
      padding: 0 4px;
    }

    .expr .op {
      padding: 0 8px;
      color: #00838f;
    }

    .expr .paren {
      color: #6a1b9a;
      font-weight: 800;
    }

    .expr .negative {
      color: #ad1457;
    }

    .decimal-input {
      font-size: 1.35em;
      padding: 14px 16px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      width: min(420px, 90%);
      text-align: center;
    }

    .input-hint {
      font-size: 0.95em;
      color: #666;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>

<body>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-box">
      <h3>Biztosan ez a v√°laszod?</h3>
      <p>Ezt a v√°laszt adtad meg:</p>
      <div id="modal-answer-display" class="modal-answer-preview"></div>
      <p style="font-size: 0.9em; color: #666;">Ha r√°nyomsz az Igen-re, elmentj√ºk √©s l√©p√ºnk tov√°bb. Ha Nem,
        jav√≠thatsz.</p>
      <div class="modal-buttons">
        <button class="btn-modal-no" onclick="closeModal(false)">‚ùå Nem, jav√≠tom</button>
        <button class="btn-modal-yes" onclick="closeModal(true)">‚úÖ Igen, tov√°bb</button>
      </div>
    </div>
  </div>

  <h1>ü¶ä Tizedesman√≥ Teszt</h1>

  <div class="container">

    <div id="start-screen">
      <h2>Szia! Hogy h√≠vnak?</h2>

      <div class="warning-box">
        <h3>‚ùó Fontos tudnival√≥k ‚ùó</h3>
        <p>Ez a teszt <strong>16 feladatot</strong> tartalmaz tizedes t√∂rtekkel.</p>
        <p>Minden feladat <strong>1 pont</strong>. Maxim√°lis pont: <strong>16</strong>.</p>
        <p>A v√°laszodban haszn√°lhatsz <strong>vessz≈ët</strong> vagy <strong>pontot</strong> (pl. 3,25 = 3.25).</p>
        <p style="margin-top:10px; border-top: 1px solid #f57f17; padding-top:5px;">
          üí° Ha v√©letlen√ºl bez√°rod az ablakot, visszaj√∂hetsz √©s folytathatod!
        </p>
      </div>

      <div id="resume-area">
        <h3 style="color:#e65100;">Tal√°ltam egy f√©lbehagyott tesztet!</h3>
        <p>Tanul√≥: <strong id="resume-name"></strong></p>
        <p>Feladat: <strong id="resume-progress"></strong></p>
        <button class="btn-resume" onclick="resumeGame()">‚ñ∂Ô∏è Folytat√°s innen</button>
        <button class="btn-reset" onclick="resetAndStartNew()">üóëÔ∏è Nem √©n vagyok / √öjrakezd√©s</button>
      </div>

      <form id="new-game-area" style="width: 100%;">
        <input type="text" id="name-input" placeholder="√çrd ide a neved..." required>
        <button type="submit" class="btn-start">Teszt ind√≠t√°sa</button>
      </form>
    </div>

    <div id="game-screen">

      <div class="top-bar">
        <div>
          <span class="student-name-display" id="display-name">Tanul√≥</span> |
          <span id="progress-text">1 / 16. feladat</span>
        </div>
      </div>

      <div class="problem-container" id="problem-box"></div>

      <div class="answer-section" id="answer-input-section">
        <div class="input-row" style="flex-direction:column; gap:10px; width:100%; align-items:center;">
          <input type="text" id="inp-dec" class="decimal-input" inputmode="decimal"
            placeholder="V√°lasz (pl. 3,25 vagy -1,5)">
          <div class="input-hint">Tipp: haszn√°lhatsz <strong>vessz≈ët</strong> vagy <strong>pontot</strong>. (3,25 =
            3.25)</div>
        </div>
      </div>

      <div class="nav-buttons">
        <button class="btn-prev" onclick="prevProblem()" id="btn-prev">‚¨ÖÔ∏è El≈ëz≈ë</button>
        <button class="btn-next" onclick="attemptNext()" id="btn-next">K√∂vetkez≈ë ‚û°Ô∏è</button>
      </div>

    </div>

    <div id="report-screen">
      <h2>üìä Felm√©r≈ë Eredm√©ny</h2>

      <div class="summary-box">
        <div class="summary-score">
          El√©rt pontsz√°m: <strong id="final-score"></strong> / <span id="final-max"></span> pont (<span
            id="final-percent"></span>%)
        </div>
        <div>
          <div class="grade-label">√ârdemjegy</div>
          <div class="grade-value" id="final-grade"></div>
        </div>
      </div>

      <div id="status-message"></div>

      <button id="btn-send-data" class="btn-send" onclick="sendReportToGoogle()">
        üöÄ Eredm√©ny k√ºld√©se a Tan√°rnak
      </button>

      <p style="margin-top:20px; font-size:0.9em; color:#666;">
        Ha a k√ºld√©s nem siker√ºlne, itt a biztons√°gi m√°solat:
      </p>
      <textarea id="report-output" readonly rows="10"></textarea>

      <div class="report-buttons">
        <button onclick="copyReport()" style="background-color:#555; color:white; font-size:0.9em;">M√°sol√°s
          v√°g√≥lapra (Tartal√©k)</button>
        <button onclick="window.location.reload()" style="background-color:#ff9800; color:white;">√öjrakezd√©s</button>
      </div>
    </div>
  </div>

  <script>
    /* ===========================================================
       Tizedesman√≥ Teszt
       - pontos ellen≈ërz√©s: racion√°lis sz√°mok (n/d) √∂sszehasonl√≠t√°sa
       - nincs eg√©sz sz√°m a feladatokban, kiv√©ve: oszt√°s eg√©sz oszt√≥val (csak az oszt√≥ lehet eg√©sz)
       - vessz≈ë/pont bevitel elfogadva
       - ment√©s/folytat√°s localStorage-ban
    =========================================================== */

    "use strict";

    // --- BEFEJEZ√âS UT√ÅNI Z√ÅR√ÅS (ne lehessen visszal√©pni/jav√≠tani) ---
    window.__FINALIZED__ = false;

    function isFinalized() {
      return window.__FINALIZED__ === true;
    }

    function lockNavigationAfterSubmit() {
      // Megakad√°lyozza, hogy a b√∂ng√©sz≈ë Vissza gombj√°val visszamenjen a kit√∂lt√©shez.
      try {
        history.pushState({ final: true }, "", location.href);
        window.addEventListener("popstate", () => {
          if (isFinalized()) history.pushState({ final: true }, "", location.href);
        });
      } catch (e) {
        // Ha valami k√∂rnyezetben nem m≈±k√∂dik, a t√∂bbi v√©delem akkor is √©l.
      }
    }

    /* --- BE√ÅLL√çT√ÅSOK --- */
    const TOTAL_QUESTIONS = 16;

    // Ide m√°sold be a WebApp /exec linket, ha kell:
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxAaMcBrUw2lujLKltwkw2jwRHhW_7B9W9vURqQUqxTAZN2eclh_6f0AB_mQ1S-m7gJfw/exec"; // pl.: "https://script.google.com/macros/s/.../exec"

    // Ment√©s kulcsa
    const STORAGE_KEY = "tizedesmano_teszt_state_v1";

    /* --- √ÅLTAL√ÅNOS SEG√âD F√úGGV√âNYEK --- */
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    /* --- RACION√ÅLIS (T√ñRT) M≈∞VELETEK: pontos sz√°mol√°s --- */
    function gcd(a, b) {
      a = Math.abs(a); b = Math.abs(b);
      while (b !== 0) { const t = a % b; a = b; b = t; }
      return a;
    }
    function simplifyFrac(f) {
      let n = f.n, d = f.d;
      if (d < 0) { n = -n; d = -d; }
      if (n === 0) return { n: 0, d: 1 };
      const g = gcd(n, d);
      return { n: n / g, d: d / g };
    }
    function addFrac(a, b) { return simplifyFrac({ n: a.n * b.d + b.n * a.d, d: a.d * b.d }); }
    function subFrac(a, b) { return simplifyFrac({ n: a.n * b.d - b.n * a.d, d: a.d * b.d }); }
    function mulFrac(a, b) { return simplifyFrac({ n: a.n * b.n, d: a.d * b.d }); }
    function divFrac(a, b) {
      if (b.n === 0) return { n: 0, d: 1 };
      return simplifyFrac({ n: a.n * b.d, d: a.d * b.n });
    }
    function equalFrac(a, b) { return a.n * b.d === b.n * a.d; }

    /* --- TIZEDES PARSER / FORMAT --- */
    function parseDecimalToFraction(raw) {
      if (raw == null) return null;
      let s = String(raw).trim();
      if (s === "") return null;
      s = s.replace(/\s+/g, "");
      s = s.replace(/,/g, ".");
      if (s.startsWith("+")) s = s.slice(1);
      if (!/^-?\d+(\.\d+)?$/.test(s)) return null;

      const neg = s.startsWith("-");
      if (neg) s = s.slice(1);
      const parts = s.split(".");
      const intPart = parts[0] || "0";
      const fracPart = parts[1] || "";
      const scale = Math.pow(10, fracPart.length);
      const n = parseInt(intPart, 10) * scale + (fracPart === "" ? 0 : parseInt(fracPart, 10));
      return simplifyFrac({ n: neg ? -n : n, d: scale });
    }

    function fracToDecimalString(f) {
      // Termin√°l√≥ tizedes eset√©n visszaadja "12.34" alakban.
      // Ha nem termin√°l√≥, akkor "n/d" alakot ad (mi ezt elker√ºlj√ºk gener√°l√°skor).
      f = simplifyFrac({ n: f.n, d: f.d });
      if (f.d === 1) return String(f.n);

      let d = f.d;
      let a = 0, b = 0;
      while (d % 2 === 0) { d /= 2; a++; }
      while (d % 5 === 0) { d /= 5; b++; }
      if (d !== 1) return `${f.n}/${f.d}`;

      const k = Math.max(a, b);
      const factor = Math.pow(10, k);
      const scaledN = f.n * (factor / f.d);
      const neg = scaledN < 0;
      const absN = Math.abs(scaledN);
      const intStr = String(Math.floor(absN / factor));
      let fracStr = String(absN % factor).padStart(k, "0");
      fracStr = fracStr.replace(/0+$/, "");
      const out = fracStr.length ? `${intStr}.${fracStr}` : intStr;
      return neg ? `-${out}` : out;
    }

    function toHuDecimal(s) { return String(s).replace(/\./g, ","); }

    /* --- SZ√ÅMGENER√ÅL√ÅS: nincs eg√©sz sz√°m (kiv√©ve: oszt√°sn√°l az oszt√≥ lehet eg√©sz) --- */
    function makeStrictNonIntegerDecimal(maxAbs, maxDp, allowNegative) {
      const dp = Math.max(1, randInt(1, Math.max(1, maxDp)));
      const scale = Math.pow(10, dp);

      let absN;
      do {
        absN = randInt(1, Math.max(1, maxAbs * scale));
      } while (absN % scale === 0); // ne legyen eg√©sz

      let n = absN;
      if (allowNegative && Math.random() < 0.35) n = -n;

      const f = simplifyFrac({ n, d: scale });

      // ha egyszer≈±s√∂d√∂tt eg√©ssz√© vagy 0 lett, √∫jragy√°rtjuk
      if (f.n === 0 || f.d === 1) return makeStrictNonIntegerDecimal(maxAbs, maxDp, allowNegative);

      const str = fracToDecimalString(f);
      if (!str.includes(".")) return makeStrictNonIntegerDecimal(maxAbs, maxDp, allowNegative);

      return { str, frac: f };
    }

    function makeNonZeroDecimal(maxAbs, maxDp, allowNegative) {
      let x;
      do { x = makeStrictNonIntegerDecimal(maxAbs, maxDp, allowNegative); }
      while (x.frac.n === 0);
      return x;
    }

    function makeIntegerDivisor(minAbs, maxAbs) {
      let v;
      do { v = randInt(minAbs, maxAbs); } while (v === 0);
      return v;
    }

    /* --- FELADATT√çPUSOK (16 db, v√°ltozatos) --- */
    const PROBLEM_DEFINITIONS = [
      { id: 1, kind: "ADD", terms: 2, allowNeg: false, brackets: false, desc: "√ñsszead√°s (2 tag)" },
      { id: 2, kind: "SUB", terms: 2, allowNeg: false, brackets: false, desc: "Kivon√°s (2 tag)" },
      { id: 3, kind: "ADD", terms: 3, allowNeg: false, brackets: false, desc: "√ñsszead√°s (3 tag)" },
      { id: 4, kind: "ADD", terms: 4, allowNeg: false, brackets: true, desc: "√ñsszead√°s (4 tag, z√°r√≥jel)" },

      { id: 5, kind: "ADD", terms: 3, allowNeg: true, brackets: true, desc: "√ñsszead√°s (negat√≠v + z√°r√≥jel)" },
      { id: 6, kind: "SUB", terms: 2, allowNeg: true, brackets: false, desc: "Kivon√°s (negat√≠v sz√°mokkal)" },

      { id: 7, kind: "MUL", terms: 2, allowNeg: false, desc: "Szorz√°s" },
      { id: 8, kind: "MUL", terms: 2, allowNeg: true, desc: "Szorz√°s (negat√≠vval)" },

      { id: 9, kind: "DIV_INT", allowNeg: false, desc: "Oszt√°s (oszt√≥ eg√©sz)" },
      { id: 10, kind: "DIV_INT", allowNeg: true, desc: "Oszt√°s (oszt√≥ eg√©sz, negat√≠vval)" },

      { id: 11, kind: "DIV_DEC", allowNeg: false, desc: "Oszt√°s (oszt√≥ tizedes)" },
      { id: 12, kind: "DIV_DEC", allowNeg: true, desc: "Oszt√°s (oszt√≥ tizedes, negat√≠vval)" },

      { id: 13, kind: "BRACKETS", outer: "*", inner: "+", allowNeg: false, desc: "Szorz√°s z√°r√≥jellel: a ¬∑ (b + c)" },
      { id: 14, kind: "BRACKETS", outer: "*", inner: "-", allowNeg: false, desc: "Szorz√°s z√°r√≥jellel: a ¬∑ (b - c)" },
      { id: 15, kind: "BRACKETS", outer: "/", inner: "+", allowNeg: false, desc: "Oszt√°s z√°r√≥jellel: a : (b + c)" },
      { id: 16, kind: "BRACKETS", outer: "/", inner: "-", allowNeg: true, desc: "Oszt√°s z√°r√≥jellel: a : (b - c)" },
    ];

    /* --- FELADAT GENER√ÅL√ÅS (termin√°l√≥ eredm√©nyre sz≈±rve) --- */
    let testData = [];
    let currentIndex = 0;
    let studentName = "";
    let startTime = null;

    function buildExprHTML(tokens) {
      const parts = tokens.map(t => {
        if (t.type === "op") return `<span class="op">${t.text}</span>`;
        if (t.type === "paren") return `<span class="paren">${t.text}</span>`;
        if (t.type === "term") {
          const cls = t.neg ? "term negative" : "term";
          return `<span class="${cls}">${t.text}</span>`;
        }
        return "";
      });
      return `<div class="expr">${parts.join("")}</div>`;
    }

    function makeTerm(maxAbs, maxDp, allowNeg) {
      const x = makeNonZeroDecimal(maxAbs, maxDp, allowNeg);
      const hu = toHuDecimal(x.str);
      return { hu, frac: x.frac, neg: x.frac.n < 0 };
    }

    function ensureTerminating(fr) {
      const s = fracToDecimalString(fr);
      return !s.includes("/");
    }

    function generateOne(def) {
      const maxAbs = 9;
      const maxDp = 3;

      for (let tries = 0; tries < 800; tries++) {

        if (def.kind === "ADD") {
          const terms = [];
          for (let i = 0; i < def.terms; i++) terms.push(makeTerm(maxAbs, maxDp, def.allowNeg));

          let result = terms[0].frac;
          for (let i = 1; i < terms.length; i++) result = addFrac(result, terms[i].frac);
          if (!ensureTerminating(result)) continue;

          const corrHu = toHuDecimal(fracToDecimalString(result));
          const tokens = [];

          if (def.brackets && terms.length >= 3) {
            tokens.push({ type: "paren", text: "(" });
            tokens.push({ type: "term", text: terms[0].hu, neg: terms[0].neg });
            tokens.push({ type: "op", text: "+" });
            tokens.push({ type: "term", text: terms[1].hu, neg: terms[1].neg });
            tokens.push({ type: "paren", text: ")" });
            for (let i = 2; i < terms.length; i++) {
              tokens.push({ type: "op", text: "+" });
              tokens.push({ type: "term", text: terms[i].hu, neg: terms[i].neg });
            }
          } else {
            tokens.push({ type: "term", text: terms[0].hu, neg: terms[0].neg });
            for (let i = 1; i < terms.length; i++) {
              tokens.push({ type: "op", text: "+" });
              tokens.push({ type: "term", text: terms[i].hu, neg: terms[i].neg });
            }
          }

          return { def, tokens, correctFrac: result, correctHu: corrHu, userInput: "" };
        }

        if (def.kind === "SUB") {
          const a = makeTerm(maxAbs, maxDp, def.allowNeg);
          const b = makeTerm(maxAbs, maxDp, def.allowNeg);
          const result = subFrac(a.frac, b.frac);
          if (!ensureTerminating(result)) continue;

          return {
            def,
            tokens: [
              { type: "term", text: a.hu, neg: a.neg },
              { type: "op", text: "‚àí" },
              { type: "term", text: b.hu, neg: b.neg }
            ],
            correctFrac: result,
            correctHu: toHuDecimal(fracToDecimalString(result)),
            userInput: ""
          };
        }

        if (def.kind === "MUL") {
          const a = makeTerm(maxAbs, maxDp, def.allowNeg);
          const b = makeTerm(maxAbs, maxDp, def.allowNeg);
          const result = mulFrac(a.frac, b.frac);
          if (!ensureTerminating(result)) continue;

          return {
            def,
            tokens: [
              { type: "term", text: a.hu, neg: a.neg },
              { type: "op", text: "¬∑" },
              { type: "term", text: b.hu, neg: b.neg }
            ],
            correctFrac: result,
            correctHu: toHuDecimal(fracToDecimalString(result)),
            userInput: ""
          };
        }

        if (def.kind === "DIV_INT") {
          const a = makeTerm(maxAbs, maxDp, def.allowNeg); // osztand√≥: tizedes
          const divisor = makeIntegerDivisor(2, 12);       // oszt√≥: eg√©sz (kiv√©tel!)
          const result = divFrac(a.frac, { n: divisor, d: 1 });
          if (!ensureTerminating(result)) continue;

          return {
            def,
            tokens: [
              { type: "term", text: a.hu, neg: a.neg },
              { type: "op", text: ":" },
              { type: "term", text: String(divisor), neg: divisor < 0 }
            ],
            correctFrac: result,
            correctHu: toHuDecimal(fracToDecimalString(result)),
            userInput: ""
          };
        }

        if (def.kind === "DIV_DEC") {
          const a = makeTerm(maxAbs, maxDp, def.allowNeg);
          const b = makeTerm(maxAbs, maxDp, def.allowNeg); // oszt√≥: tizedes, nem eg√©sz
          const result = divFrac(a.frac, b.frac);
          if (!ensureTerminating(result)) continue;

          return {
            def,
            tokens: [
              { type: "term", text: a.hu, neg: a.neg },
              { type: "op", text: ":" },
              { type: "term", text: b.hu, neg: b.neg }
            ],
            correctFrac: result,
            correctHu: toHuDecimal(fracToDecimalString(result)),
            userInput: ""
          };
        }

        if (def.kind === "BRACKETS") {
          const a = makeTerm(maxAbs, maxDp, def.allowNeg);
          let b = makeTerm(maxAbs, maxDp, def.allowNeg);
          let c = makeTerm(maxAbs, maxDp, def.allowNeg);

          let inner = def.inner === "+" ? addFrac(b.frac, c.frac) : subFrac(b.frac, c.frac);
          if (inner.n === 0) continue;

          let result = (def.outer === "*") ? mulFrac(a.frac, inner) : divFrac(a.frac, inner);
          if (!ensureTerminating(result)) continue;

          const innerHu = toHuDecimal(fracToDecimalString(inner));
          const corrHu = toHuDecimal(fracToDecimalString(result));

          return {
            def,
            tokens: [
              { type: "term", text: a.hu, neg: a.neg },
              { type: "op", text: def.outer === "*" ? "¬∑" : ":" },
              { type: "paren", text: "(" },
              { type: "term", text: b.hu, neg: b.neg },
              { type: "op", text: def.inner === "+" ? "+" : "‚àí" },
              { type: "term", text: c.hu, neg: c.neg },
              { type: "paren", text: ")" },
            ],
            correctFrac: result,
            correctHu: corrHu,
            userInput: ""
          };
        }
      }

      // fallback (nagyon ritka)
      return {
        def,
        tokens: [{ type: "term", text: "1,2", neg: false }, { type: "op", text: "+" }, { type: "term", text: "3,4", neg: false }],
        correctFrac: parseDecimalToFraction("4.6"),
        correctHu: "4,6",
        userInput: ""
      };
    }

    function generateTestData() {
      testData = PROBLEM_DEFINITIONS.map(def => generateOne(def));
    }

    /* --- K√âPERNY≈êV√ÅLT√ÅS --- */
    function showScreen(id) {
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("game-screen").style.display = "none";
      document.getElementById("report-screen").style.display = "none";
      document.getElementById(id).style.display = (id === "start-screen") ? "flex" : "block";
    }

    /* --- STATE (ment√©s/folytat√°s) --- */
    function saveState() {
      const payload = {
        studentName,
        currentIndex,
        startTime: startTime ? startTime.toISOString() : null,
        testData: testData.map(q => ({ userInput: q.userInput || "" })),
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const payload = JSON.parse(raw);
        if (!payload || !payload.studentName || typeof payload.currentIndex !== "number") return false;

        studentName = payload.studentName;
        currentIndex = payload.currentIndex;
        startTime = payload.startTime ? new Date(payload.startTime) : null;

        generateTestData();
        (payload.testData || []).forEach((u, i) => {
          if (testData[i]) testData[i].userInput = String(u.userInput || "");
        });

        document.getElementById("resume-name").innerText = studentName;
        document.getElementById("resume-progress").innerText = `${currentIndex + 1} / ${TOTAL_QUESTIONS}`;
        document.getElementById("resume-area").style.display = "flex";
        return true;
      } catch {
        return false;
      }
    }

    function clearState() {
      localStorage.removeItem(STORAGE_KEY);
    }

    function resumeGame() {
      document.getElementById("display-name").innerText = studentName;
      showScreen("game-screen");
      loadQuestion(currentIndex);
    }

    function resetAndStartNew() {
      clearState();
      window.location.reload();
    }

    /* --- FELADAT MEGJELEN√çT√âS --- */
    function loadQuestion(idx) {
      currentIndex = idx;
      const q = testData[currentIndex];

      document.getElementById("display-name").innerText = studentName;
      document.getElementById("progress-text").innerText = `${currentIndex + 1} / ${testData.length}. feladat`;

      document.getElementById("problem-box").innerHTML = buildExprHTML(q.tokens);

      const inp = document.getElementById("inp-dec");
      inp.value = q.userInput || "";
      inp.focus();

      document.getElementById("btn-prev").style.display = (currentIndex === 0) ? "none" : "inline-block";
      document.getElementById("btn-next").textContent = (currentIndex === testData.length - 1) ? "Bead√°s ‚úÖ" : "K√∂vetkez≈ë ‚û°Ô∏è";

      saveState();
    }

    function prevProblem() {
      if (isFinalized()) return;
      saveCurrentAnswer();
      if (currentIndex > 0) loadQuestion(currentIndex - 1);
    }

    function attemptNext() {
      if (isFinalized()) return;

      saveCurrentAnswer();

      const q = testData[currentIndex];
      const raw = (q.userInput || "").trim();
      const userFrac = parseDecimalToFraction(raw);

      if (!raw) {
        alert("K√©rlek √≠rj be egy v√°laszt!");
        return;
      }
      if (!userFrac) {
        alert("Nem √©rtelmezhet≈ë sz√°m. P√©lda: 3,25 vagy -1,5");
        return;
      }

      openModal(raw);
    }

    function saveCurrentAnswer() {
      const inp = document.getElementById("inp-dec");
      testData[currentIndex].userInput = (inp.value || "").trim();
      saveState();
    }

    /* --- MODAL --- */
    function openModal(answerText) {
      document.getElementById("modal-answer-display").innerText = answerText;
      document.getElementById("confirm-modal").style.display = "flex";
    }

    function closeModal(confirmed) {
      document.getElementById("confirm-modal").style.display = "none";
      if (!confirmed) return;

      if (currentIndex < testData.length - 1) {
        loadQuestion(currentIndex + 1);
      } else {
        finishGame();
      }
    }

    /* --- KI√âRT√âKEL√âS --- */
    function gradeFromPercent(p) {
      if (p >= 90) return 5;
      if (p >= 75) return 4;
      if (p >= 60) return 3;
      if (p >= 40) return 2;
      return 1;
    }

    function finishGame() {
      const endTime = new Date();
      const minutes = startTime ? ((endTime - startTime) / 60000) : 0;

      let correct = 0;
      let reportLines = [];
      reportLines.push(`N√©v: ${studentName}`);
      reportLines.push(`Id≈ë: ${minutes.toFixed(1)} perc`);
      reportLines.push(`---`);

      testData.forEach((q, i) => {
        const userRaw = (q.userInput || "").trim();
        const userFrac = parseDecimalToFraction(userRaw);
        const ok = userFrac && equalFrac(userFrac, q.correctFrac);
        if (ok) correct++;

        const exprText = q.tokens.map(t => t.text).join(" ");
        reportLines.push(`${i + 1}. ${exprText} = ${userRaw || "‚àÖ"}  |  Helyes: ${q.correctHu}  |  ${ok ? "‚úÖ" : "‚ùå"}`);
      });

      const total = testData.length;
      const percent = total ? Math.round((correct / total) * 100) : 0;
      const grade = gradeFromPercent(percent);

      document.getElementById("final-score").innerText = String(correct);
      document.getElementById("final-max").innerText = String(total);
      document.getElementById("final-percent").innerText = String(percent);
      document.getElementById("final-grade").innerText = String(grade);

      const reportText = reportLines.join("\n");
      document.getElementById("report-output").value = reportText;

      window.__REPORT_PACKAGE__ = {
        name: studentName,
        score: correct,
        correct: correct,
        total: total,
        time: minutes.toFixed(1),
        settings: "Tizedesman√≥ Teszt (v1) | Nincs eg√©sz operandus (kiv√©ve: oszt√≥ eg√©sz)",
        log: reportText
      };

      const btnSend = document.getElementById("btn-send-data");
      const statusDiv = document.getElementById("status-message");
      const configured = !(GOOGLE_SCRIPT_URL === "IDE_MASOLD_BE_A_GOOGLE_SCRIPT_LINKET" || GOOGLE_SCRIPT_URL === "");

      btnSend.style.display = "block";
      btnSend.disabled = !configured;

      statusDiv.innerText = configured
        ? ""
        : "‚ö†Ô∏è A k√ºld√©s nincs be√°ll√≠tva ezen a g√©pen (GOOGLE_SCRIPT_URL √ºres). K√©rd meg a tan√°rt, hogy √°ll√≠tsa be.";

      // Z√°r√°s: bead√°s ut√°n ne lehessen visszal√©pni vagy jav√≠tani
      window.__FINALIZED__ = true;
      lockNavigationAfterSubmit();

      clearState();
      showScreen("report-screen");
    }

    /* --- REPORT: m√°sol√°s √©s k√ºld√©s --- */
    function copyReport() {
      const ta = document.getElementById("report-output");
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      document.execCommand("copy");
      alert("M√°solva a v√°g√≥lapra!");
    }

    function sendReportToGoogle() {
      const statusDiv = document.getElementById("status-message");
      const btn = document.getElementById("btn-send-data");

      if (GOOGLE_SCRIPT_URL === "IDE_MASOLD_BE_A_GOOGLE_SCRIPT_LINKET" || GOOGLE_SCRIPT_URL === "") {
        statusDiv.innerText = "‚ö†Ô∏è Nincs be√°ll√≠tva a Google Script link (GOOGLE_SCRIPT_URL).";
        return;
      }

      const data = window.__REPORT_PACKAGE__ || {};
      btn.disabled = true;
      btn.textContent = "K√ºld√©s...";

      const body = new URLSearchParams();
      for (const [k, v] of Object.entries(data)) body.append(k, String(v ?? ""));

      fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body })
        .then(() => {
          statusDiv.innerText = "‚úÖ K√ºld√©s megt√∂rt√©nt! (N√©zd a t√°bl√°zatot.)";
          btn.style.display = "none";
        })
        .catch(() => {
          statusDiv.innerText = "‚ùå Hiba a k√ºld√©skor. M√°sold ki a jelent√©st tartal√©knak.";
          btn.disabled = false;
          btn.textContent = "üöÄ Eredm√©ny k√ºld√©se a Tan√°rnak";
        });
    }

    /* --- IND√çT√ÅS --- */
    document.getElementById("new-game-area").addEventListener("submit", (ev) => {
      ev.preventDefault();
      const inp = document.getElementById("name-input");
      studentName = (inp.value || "").trim();
      if (!studentName) { alert("K√©rlek √≠rd be a neved!"); return; }

      generateTestData();
      startTime = new Date();
      currentIndex = 0;

      saveState();
      showScreen("game-screen");
      loadQuestion(0);
    });

    window.addEventListener("load", () => {
      const has = loadState();
      if (has && studentName && testData.length) {
        const ok = confirm(`Tal√°ltam egy f√©lbehagyott tesztet (${studentName}). Folytatod?`);
        if (ok) {
          document.getElementById("display-name").innerText = studentName;
          showScreen("game-screen");
          loadQuestion(currentIndex);
        } else {
          clearState();
          document.getElementById("resume-area").style.display = "none";
        }
      }
    });
  </script>

</body>

</html>